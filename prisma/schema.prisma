generator client {
    provider = "prisma-client"
    output   = "../src/generated/prisma"
    runtime  = "deno"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum LocationType {
    combat
    event
    elite
    tavern
    treasure
    boss
    campfire
    shop
}

model Player {
    id               BigInt            @id
    name             String
    health           Int
    maxHealth        Int               @default(10)
    createdAt        DateTime          @default(now())
    updatedAt        DateTime          @updatedAt
    encounterPlayers EncounterPlayer[]
}

model Location {
    id          String       @id
    row         Int
    col         Int
    name        String
    description String
    attributes  Json
    type        LocationType
    createdAt   DateTime     @default(now())
    updatedAt   DateTime     @updatedAt
    fromPaths   Path[]       @relation("FromLocation")
    toPaths     Path[]       @relation("ToLocation")
    guilds      Guild[]      @relation("GuildCurrentLocation")
    map         Map          @relation(fields: [mapId], references: [id], onDelete: Cascade)
    mapId       String
}

model Path {
    id             String   @id
    fromLocation   Location @relation("FromLocation", fields: [fromLocationId], references: [id])
    fromLocationId String
    toLocation     Location @relation("ToLocation", fields: [toLocationId], references: [id])
    toLocationId   String
    description    String
    attributes     Json
    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt
    map            Map      @relation(fields: [mapId], references: [id], onDelete: Cascade)
    mapId          String
}

model Guild {
    id                BigInt    @id
    updatedAt         DateTime  @updatedAt
    seed              String    @default(uuid())
    randomCursor      Int       @default(0)
    currentLocationId String?
    currentLocation   Location? @relation("GuildCurrentLocation", fields: [currentLocationId], references: [id])
    map               Map?
    mapId             String?   @unique
}

model Map {
    id        String     @id @default(uuid())
    locations Location[]
    paths     Path[]
    createdAt DateTime   @default(now())
    updatedAt DateTime   @updatedAt
    rows      Int
    cols      Int
    guildId   BigInt?    @unique
    guild     Guild?     @relation(fields: [guildId], references: [id])
}

model Enemy {
    id         String           @id @default(uuid())
    name       String
    maxHealth  Int
    health     Int
    encounters EncounterEnemy[]
}

model Encounter {
    id        String            @id @default(uuid())
    players   EncounterPlayer[]
    enemies   EncounterEnemy[]
    status    EncounterStatus
    createdAt DateTime          @default(now())
    updatedAt DateTime          @updatedAt
}

model EncounterPlayer {
    id          String    @id @default(uuid())
    encounter   Encounter @relation(fields: [encounterId], references: [id])
    encounterId String
    player      Player    @relation(fields: [playerId], references: [id])
    playerId    BigInt
    initiative  Int
}

model EncounterEnemy {
    id          String    @id @default(uuid())
    encounter   Encounter @relation(fields: [encounterId], references: [id])
    encounterId String
    enemy       Enemy     @relation(fields: [enemyId], references: [id])
    enemyId     String
    initiative  Int
}

enum EncounterStatus {
    active
    victory
    defeat
}
